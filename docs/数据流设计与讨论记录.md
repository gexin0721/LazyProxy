# 数据流设计

## 一、整体架构

单实例服务端，作为客户端与 AI 模型之间的中转层。核心职责：认证鉴权、连接管理、流式转发、额度计量。

| 组件 | 选型 | 说明 |
|------|------|------|
| 令牌存储 | Redis | 利用 TTL 自动过期清理 |
| 连接映射 | 内存 Map（并发安全） | 哈希值(key) → 模型连接(value) |
| 历史存储 | 云端 | 客户端定期上报，服务端转存 |

---

## 二、数据流四个阶段

### 阶段1：握手认证

```
客户端 ──握手请求──▶ 服务端
                      │
                      ├─ 1. 验证设备码、用户名、用户权限
                      ├─ 2. 会话ID(客户端生成) + 用户名 → 哈希值
                      ├─ 3. 生成临时令牌
                      │     ├─ 返回给客户端
                      │     └─ 存入 Redis（设置 TTL）
                      │
客户端 ◀──令牌+哈希──┘
```

- 会话ID由客户端生成，支持多个（多对话窗口场景）
- 用户名参与哈希计算，防止不同用户的会话ID碰撞
- 令牌存 Redis，过期自动清理，无需手动维护

### 阶段2：模型请求与连接建立

```
客户端 ──哈希值+模型名+参数──▶ 服务端
                                │
                                ├─ 1. 校验用户权限是否允许该模型
                                │     ├─ 不允许 → 返回失败
                                │     └─ 允许 → 继续
                                ├─ 2. 与目标模型建立连接
                                │     ├─ 参数错误 → 返回具体错误信息
                                │     └─ 服务端流量不足 → 返回"服务器繁忙，请稍后重试"
                                ├─ 3. 连接成功 → 存入 Map（哈希值 → 连接）
                                │     （连接失败时 Map 中不存入任何条目）
                                │
客户端 ◀──成功/失败────────────┘
```

### 阶段3：问题转发（流式中转）

```
客户端 ──哈希值+问题──▶ 服务端 ──────────▶ AI模型
                         │                    │
                         ├─ 1. 验证令牌有效性   │
                         │   └─ 过期 → 返回错误  │
                         │     (客户端调用刷新令牌接口)│
                         ├─ 2. 验证额度          │
                         ├─ 3. 从Map取连接       │
                         ├─ 4. 转发问题 ─────────┘
                         │
                         │    ◀── 流式返回 ──────┘
                         ├─ 5. 流式转发给客户端
                         ├─ 6. 流结束后，token计算库统计消耗，扣减额度
                         │
客户端 ◀──流式响应───┘
```

**令牌刷新机制：**
- 令牌过期时，客户端调用服务端的令牌刷新接口（非重新握手）
- 服务端校验用户资格与剩余额度，通过后签发新令牌，不通过则拒绝
- Map 中的连接不断开，执行 key 值切换（旧key取出连接 → 删旧key → 新key插入）
- 该切换逻辑与用户切换模型的逻辑复用
- key 切换操作需保证原子性（加锁或使用并发安全结构）

**额度扣减策略：**

| 场景 | 扣费 | 实现方式 |
|------|------|----------|
| 正常回复结束 | 扣 | token 计算库统计已消耗量 |
| 用户主动中断 | 扣 | 客户端发送中断请求(HTTP)，服务端建标志位，按已消耗 token 扣 |
| 服务端网络中断 | 不扣 | 无中断标志位且连接异常断开，判定为网络问题 |

**流式中转异常处理：**
- 客户端断开、模型仍在输出 → 主动取消上游模型请求，避免额度浪费
- 模型侧中途断开、客户端仍在等 → 返回明确错误信号
- 背压（模型输出快于客户端接收） → 流控机制或缓冲上限

### 阶段4：历史同步

```
客户端 ──定期上报聊天历史──▶ 服务端 ──转存──▶ 云端
```

- 客户端定期批量发送聊天历史到服务端
- 服务端接收后转存至云端，保持用户历史记录
- 用户换设备登录时，从云端拉取历史

---

## 三、连接健康管理

两类超时场景需区分处理：

| 超时类型 | 原因 | 处理 |
|----------|------|------|
| 服务端容量超时 | 连接过多，服务器处理不过来 | 拒绝新连接，返回繁忙 |
| 业务层超时 | 单个连接上问答过程超时 | 通知客户端，清理该连接 |

---

## 四、待实现阶段细化

1. 连接健康检查的具体实现方式（心跳、超时检测等）
2. 流式中转的背压控制具体方案
3. token 计算库的选型
4. 历史同步的具体频率和批量策略
